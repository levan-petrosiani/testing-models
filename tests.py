import requests
import json
from datetime import datetime

OLLAMA_URL = "http://localhost:11434/api/chat"
MODELS = ["qwen2.5:14b"]

timestamp = datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
filename = f"{timestamp}-test.md"

test_cases = [
    "მე გუშინ წავედი მაღაზიაში და ვიყიდე პური, მერე მოვედი სახლში.",
    "მან მითხრა რომ მოვა მაგრამ არ მოვიდა.",
    "ბავშვიები დარბიან ეზოში.",
    "ჩვენ წავედით ქალაქში სადაც ბევრი ხალხი იყო.",
    "პროექტი რომელიც ჩვენ დავიწყეთ წარმატებული იქნება."
]

def run_test(model, text):
    prompt = f"""
შენ ხარ ქართული ენის ექსპერტი კორექტორი. შენი ერთადერთი ამოცანაა გაასწორო მხოლოდ აშკარა ორთოგრაფიული, გრამატიკური და პუნქტუაციის შეცდომები მინიმალური ცვლილებებით.

წესები (აუცილებლად დაიცავი ყველა):
- გაასწორე მხოლოდ შეცდომები: ორთოგრაფია (მაგ. სჰ → შ), გრამატიკა (შეთანხმება, შემთხვევები, დროები), პუნქტუაცია (მძიმეები რომ-თან, თუმცა-თან, ჩასმული სიტყვებით).
- არ შეცვალო სწორი სიტყვები, დროები ან მნიშვნელობა.
- არ დაამატო ან ამოიღო სიტყვები, თუ ეს აბსოლუტურად აუცილებელი არ არის გრამატიკისთვის (მაგ. ორმაგი 'და' ამოიღე).
- თუ ტექსტი უკვე სწორია, დააბრუნე უცვლელად.
- უპასუხე მხოლოდ და მხოლოდ გასწორებული ტექსტით. არც ახსნა, არც "Output:", არც "Explanation:", არც შენიშვნა, არც ბრჭყალები, არც არაფერი სხვა.

ფიქრის პროცესი (გააკეთე გონებაში ნაბიჯ-ნაბიჯ, მაგრამ არ დაწერო):
1. წაიკითხე ტექსტი და გამოყავი შესაძლო შეცდომები: ორთოგრაფია, შეთანხმება (სუბიექტი-ზმნა), შემთხვევები (ერგატიული წარსულში), დროები (აგლუტინაცია), პუნქტუაცია (მძიმეები რომ-თან, ჩასმულებთან, კონიუნქციებთან), რედუნდანტობა (ორმაგი სიტყვები), რიცხვები (რიცხვი + მხოლობითი).
2. თუ გაურკვეველია, მენტალურად თარგმნე ინგლისურში (როგორც მაღალრესურსულ ენაში), გაასწორე იქ გრამატიკა, შემდეგ უკან თარგმნე ქართულში მინიმალური ცვლილებებით (არ შეცვალო მნიშვნელობა).
3. გააკეთე მინიმალური ცვლილებები და შეამოწმე, რომ მნიშვნელობა უცვლელი დარჩეს.
4. ბოლოს, გამოიტანე მხოლოდ გასწორებული ტექსტი.

მაგალითები:
მაგალითი 1 (შეთანხმება):
Input: ბავშვებმა დაინახა კატა და გაიქცნენ.
Output: ბავშვებმა დაინახეს კატა და გაიქცნენ.

მაგალითი 2 (პუნქტუაცია რომ-თან):
Input: მან თქვა რომ მოვა მაგრამ არ მოვიდა.
Output: მან თქვა, რომ მოვა, მაგრამ არ მოვიდა.

მაგალითი 3 (ზმნის დრო/აგლუტინაცია):
Input: ისინი სახლს აშენებენ წინა წელს.
Output: ისინი სახლს აშენებდნენ წინა წელს.

მაგალითი 4 (შემთხვევა - ერგატიული):
Input: კაცი დაინახა მეგობარი.
Output: კაცმა დაინახა მეგობარი.

მაგალითი 5 (რედუნდანტობა):
Input: ჩვენ წავედით ქალაქში სადაც ბევრი ხალხი იყო და და დავისვენეთ.
Output: ჩვენ წავედით ქალაქში, სადაც ბევრი ხალხი იყო და დავისვენეთ.

მაგალითი 6 (ჩასმული სიტყვები/პუნქტუაცია):
Input: ეს რა თქმა უნდა სიმართლეა.
Output: ეს, რა თქმა უნდა, სიმართლეა.

მაგალითი 7 (რიცხვები + მხოლობითი):
Input: ხუთი მეგობრები მოვიდნენ.
Output: ხუთი მეგობარი მოვიდა.

მაგალითი 8 (კონიუნქციები):
Input: არა მხოლოდ ის არამედ მისი ძმაც მოვიდა.
Output: არა მხოლოდ ის, არამედ მისი ძმაც მოვიდა.

მაგალითი 9 (ორთოგრაფია/ფონეტიკური):
Input: სჰეცდომა არის სჰესასწორებელი.
Output: შეცდომა არის შესასწორებელი.

მაგალითი 10 (სწორი ტექსტი - უცვლელი):
Input: კომპიუტერული ტექნოლოგიები და ინოვაციები მნიშვნელოვანია.
Output: კომპიუტერული ტექნოლოგიები და ინოვაციები მნიშვნელოვანია.

ახლა გაასწორე:
Input: {text}
Output:
"""
    
    payload = {
        "model": model,
        "messages": [
            {
                "role": "system",
                "content": prompt
            },
            {
                "role": "user",
                "content": text
            }
        ],
        "stream": False,
        "options": {
            "temperature": 0,
            "stop": ["Explanation:", "Output:", "Note:"]
        }
    }
    
    try:
        r = requests.post(OLLAMA_URL, json=payload, timeout=30)
        response = r.json().get('message', {}).get('content', '').strip()
        
        # Final cleanup for stubborn models
        clean = response.split("Output:")[-1].split("Explanation:")[0].strip()
        return clean
    except Exception as e:
        return f"Error: {str(e)}"

def escape_pipe(text):
    return text.replace("|", "\\|")

# Generate clean Markdown table
with open(filename, "w", encoding="utf-8") as f:
    f.write("| Original Text | Model | Corrected Version |\n")
    f.write("| :--- | :--- | :--- |\n")

    for case in test_cases:
        original_escaped = escape_pipe(case)
        for model in MODELS:
            print(f"Testing {model}")
            result = run_test(model, case)
            result_escaped = escape_pipe(result)
            f.write(f"| {original_escaped} | **{model}** | {result_escaped} |\n")

print("\nBenchmark complete! Check results.md for the clean Markdown table.")